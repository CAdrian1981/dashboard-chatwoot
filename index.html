<script>
  // Esperamos a que el documento HTML esté completamente cargado y analizado
  document.addEventListener('DOMContentLoaded', function() {

    function getCurrentMonthId() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      return `${year}${month}`;
    }

    function fillDashboard(data) {
      const currentMonth = getCurrentMonthId();
      const record = data.find(row => row.Mes === currentMonth);
      const titleElement = document.getElementById("title");

      if (!record) {
        titleElement.textContent = "Sin datos para este mes";
        return;
      }

      // Usar un objeto de mapeo hace el código más limpio y fácil de mantener
      const elementMapping = {
        "fibra": record["Fibras brutas"],
        "movact": record["Mov activos"],
        "movvuelo": record["Mov en vuelo"],
        "gratis": record["% Linea gratis"],
        "dias": record["Días instalación"]
      };

      // Recorremos el objeto para rellenar los datos
      for (const id in elementMapping) {
        const element = document.getElementById(id);
        if (element) {
          // El operador '??' asigna '-' si el valor es null o undefined
          element.textContent = elementMapping[id] ?? '-';
        }
      }

      titleElement.textContent = `Totales para ${currentMonth}`;
    }

    async function initializeDashboard(pdvId) {
      try {
        const url = `https://n8n.vozipyme.es/webhook/dashboard_chatwoot_pdv?pdv_id=${pdvId}`;
        const response = await fetch(url);
        // Comprobamos si la petición falló (ej. error 404 o 500)
        if (!response.ok) {
            throw new Error(`Error HTTP! estado: ${response.status}`);
        }
        const data = await response.json();
        fillDashboard(data);
      } catch (error) {
        console.error("Error cargando datos:", error);
        document.getElementById("title").textContent = "Error al cargar datos";
      }
    }

    function handleAppContext(ctx) {
      const pdvId = ctx?.contact?.custom_attributes?.ID_PDV;
      if (pdvId) {
        initializeDashboard(pdvId);
      } else {
        document.getElementById("title").textContent = "PDV no definido";
      }
    }

    // --- Lógica principal de ejecución ---
    if (window.chatwootWebChannel) {
      window.chatwootWebChannel.on("app_context", handleAppContext);
      window.chatwootWebChannel.getAppContext();
    } else {
      // Alternativa para pruebas locales usando un parámetro en la URL (ej: ?pdv_id=PDV48)
      const urlParams = new URLSearchParams(window.location.search);
      const pdvId = urlParams.get("pdv_id");
      if (pdvId) {
        initializeDashboard(pdvId);
      } else {
         document.getElementById("title").textContent = "Esperando contexto...";
      }
    }
  });
</script>
