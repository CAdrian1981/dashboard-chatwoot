<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard PDV</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 1rem;
    }
    h2 {
      text-align: center;
      margin-bottom: 2rem;
    }
    .grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
    }
    .card {
      background: white;
      padding: 1rem 2rem;
      border-radius: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      min-width: 160px;
      text-align: center;
    }
    .value {
      font-size: 2rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2 id="title">Esperando datos del PDV...</h2>
  <div class="grid">
    <div class="card"><div>Fibras Brutas</div><div class="value" id="fibras"></div></div>
    <div class="card"><div>Mov Activos</div><div class="value" id="activos"></div></div>
    <div class="card"><div>Mov en Vuelo</div><div class="value" id="vuelo"></div></div>
    <div class="card"><div>% Línea Gratis</div><div class="value" id="gratis"></div></div>
    <div class="card"><div>Días Instalación</div><div class="value" id="dias"></div></div>
  </div>

  <script>
    window.addEventListener("message", async (event) => {
      const data = event.data;
      if (!data || !data.contact || !data.contact.custom_attributes) return;

      const pdvId = data.contact.custom_attributes.ID_PDV;
      if (!pdvId) return;

      document.getElementById("title").textContent = `Totales para PDV ${pdvId}`;
      try {
        const res = await fetch(`https://n8n.vozipyme.es/webhook/dashboard_chatwoot_pdv?pdv_id=${pdvId}`);
        const items = await res.json();
        const hoy = new Date();
        const mesActual = hoy.getFullYear().toString() + ("0" + (hoy.getMonth() + 1)).slice(-2);
        const mes = items.find((e) => e.Mes === mesActual);

        if (mes) {
          document.getElementById("fibras").textContent = mes["Fibras brutas"] ?? "-";
          document.getElementById("activos").textContent = mes["Mov activos"] ?? "-";
          document.getElementById("vuelo").textContent = mes["Mov en vuelo"] ?? "-";
          document.getElementById("gratis").textContent = mes["% Linea gratis"]?.toFixed(2) ?? "-";
          document.getElementById("dias").textContent = mes["Días instalación"] ?? "-";
        }
      } catch (e) {
        console.error("Error cargando datos", e);
      }
    }, false);
  </script>
</body>
</html>
