<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Ventas PDV</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #f8f9fa;
            color: #333;
        }
        .dashboard-container {
            width: 100%;
            max-width: 1200px; /* Aumentado el ancho para la nueva tabla */
            margin: auto;
        }
        .kpi-section-title {
            text-align: center;
            font-size: 1.2em;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
        }
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .kpi-card {
            background: #ffffff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            text-align: center;
        }
        .kpi-title {
            font-size: 0.9em;
            color: #6c757d;
            margin: 0 0 5px 0;
        }
        .kpi-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #000;
            margin: 0;
        }
        .chart-container {
            position: relative;
            background: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            /* 1. NUEVO: Gráfico con el doble de altura */
            max-height: 900px; 
        }
        .table-container {
            margin-top: 25px;
            background: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        /* 2. NUEVO: Estilos para los filtros desplegables */
        .table-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .table-filters select {
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            flex-grow: 1;
        }
        /* 3. NUEVO: Contenedor de la tabla con scroll horizontal y vertical */
        .data-table-wrapper {
            max-height: 280px; /* Altura para ~5 filas con cabecera */
            overflow: auto; /* Scroll en ambas direcciones */
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            white-space: nowrap; /* Evita que el texto se parta en varias líneas */
        }
        th {
            cursor: pointer;
            background-color: #f1f3f5;
        }
        /* 4. NUEVO: Estilos para las columnas fijas (inmóviles) */
        th:nth-child(1), td:nth-child(1) {
            position: sticky;
            left: 0;
            z-index: 2;
            background-color: #f1f3f5; /* Mismo fondo que la cabecera para consistencia */
        }
        td:nth-child(1) {
             background-color: #ffffff; /* Fondo blanco para las celdas de datos */
        }
        th:nth-child(2), td:nth-child(2) {
            position: sticky;
            /* El valor de left debe ser el ancho de la primera columna. 
               Se ajustará con JavaScript para ser dinámico. */
            left: 100px; 
            z-index: 2;
            background-color: #f1f3f5;
        }
        td:nth-child(2) {
             background-color: #ffffff;
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        
        <h3 id="kpi-month-title" class="kpi-section-title"></h3>
        
        <div class="kpi-container">
            <div class="kpi-card"><p class="kpi-title">Total Fibras Brutas</p><p class="kpi-value" id="total-fibra-bruta">0</p></div>
            <div class="kpi-card"><p class="kpi-title">Total Mov. Activos</p><p class="kpi-value" id="total-mov-activo">0</p></div>
            <div class="kpi-card"><p class="kpi-title">Total Mov. en Vuelo</p><p class="kpi-value" id="total-mov-vuelo">0</p></div>
            <div class="kpi-card"><p class="kpi-title">Prom. % Línea Gratis</p><p class="kpi-value" id="avg-linea-gratis">0%</p></div>
            <div class="kpi-card"><p class="kpi-title">Prom. Días Instal.</p><p class="kpi-value" id="avg-dias-instal">0</p></div>
        </div>

        <div class="chart-container">
            <canvas id="salesChart"></canvas>
        </div>

        <div class="table-container">
            <div class="table-filters">
                <select id="monthFilter"></select>
                <select id="pdvFilter"></select>
            </div>
            <div class="data-table-wrapper">
                <table id="dataTable">
                    <thead>
                        </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        const salesData = [{"Mes":"202404","ID PDV":"57317","Fibras brutas":9,"Mov activos":"8","Fibra activa":5,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":"13.89","% Linea gratis":0.29},{"Mes":"202405","ID PDV":"57317","Fibras brutas":3,"Mov activos":"20","Fibra activa":7,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":"5.00","% Linea gratis":0.14},{"Mes":"202405","ID PDV":"55632","Fibras brutas":1,"Mov activos":"2","Fibra activa":1,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":"13.00","% Linea gratis":0},{"Mes":"202406","ID PDV":"57317","Fibras brutas":6,"Mov activos":"12","Fibra activa":5,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":"3.17","% Linea gratis":0.71},{"Mes":"202407","ID PDV":"55632","Fibras brutas":0,"Mov activos":"1","Fibra activa":0,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":null,"% Linea gratis":null},{"Mes":"202408","ID PDV":"57317","Fibras brutas":2,"Mov activos":"20","Fibra activa":2,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":"10.00","% Linea gratis":0.19},{"Mes":"202408","ID PDV":"55632","Fibras brutas":1,"Mov activos":"0","Fibra activa":1,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":"5.00","% Linea gratis":null},{"Mes":"202409","ID PDV":"57317","Fibras brutas":2,"Mov activos":"11","Fibra activa":4,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":"14.67","% Linea gratis":0},{"Mes":"202409","ID PDV":"55632","Fibras brutas":0,"Mov activos":"1","Fibra activa":0,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":null,"% Linea gratis":null},{"Mes":"202410","ID PDV":"57317","Fibras brutas":3,"Mov activos":"8","Fibra activa":2,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":"5.67","% Linea gratis":0},{"Mes":"202410","ID PDV":"55632","Fibras brutas":1,"Mov activos":"0","Fibra activa":1,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":"10.00","% Linea gratis":null},{"Mes":"202411","ID PDV":"57317","Fibras brutas":4,"Mov activos":"5","Fibra activa":3,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":"18.50","% Linea gratis":0},{"Mes":"202411","ID PDV":"55632","Fibras brutas":0,"Mov activos":"1","Fibra activa":0,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":null,"% Linea gratis":null},{"Mes":"202501","ID PDV":"57317","Fibras brutas":3,"Mov activos":"7","Fibra activa":3,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":"5.67","% Linea gratis":0.2},{"Mes":"202501","ID PDV":"55632","Fibras brutas":1,"Mov activos":"0","Fibra activa":1,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":"8.00","% Linea gratis":null},{"Mes":"202502","ID PDV":"57317","Fibras brutas":1,"Mov activos":"10","Fibra activa":2,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":"6.00","% Linea gratis":0.11},{"Mes":"202502","ID PDV":"55632","Fibras brutas":0,"Mov activos":"1","Fibra activa":0,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":null,"% Linea gratis":null},{"Mes":"202503","ID PDV":"57317","Fibras brutas":2,"Mov activos":"10","Fibra activa":1,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":"5.00","% Linea gratis":0.11},{"Mes":"202503","ID PDV":"55632","Fibras brutas":0,"Mov activos":"2","Fibra activa":0,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":null,"% Linea gratis":0},{"Mes":"202504","ID PDV":"57317","Fibras brutas":5,"Mov activos":"14","Fibra activa":6,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":"3.40","% Linea gratis":0.13},{"Mes":"202504","ID PDV":"55632","Fibras brutas":0,"Mov activos":"3","Fibra activa":0,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":null,"% Linea gratis":0},{"Mes":"202505","ID PDV":"57317","Fibras brutas":4,"Mov activos":"5","Fibra activa":4,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":"3.80","% Linea gratis":0.33},{"Mes":"202506","ID PDV":"57317","Fibras brutas":3,"Mov activos":"11","Fibra activa":4,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":"5.33","% Linea gratis":0.14},{"Mes":"202506","ID PDV":"55632","Fibras brutas":0,"Mov activos":"1","Fibra activa":0,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":null,"% Linea gratis":0},{"Mes":"202507","ID PDV":"57317","Fibras brutas":4,"Mov activos":"7","Fibra activa":3,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":"11.50","% Linea gratis":0},{"Mes":"202507","ID PDV":"55632","Fibras brutas":0,"Mov activos":"1","Fibra activa":0,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":null,"% Linea gratis":null},{"Mes":"202508","ID PDV":"57317","Fibras brutas":1,"Mov activos":"4","Fibra activa":2,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":"12.00","% Linea gratis":0.5},{"Mes":"202412","ID PDV":"55632","Fibras brutas":0,"Mov activos":"0","Fibra activa":0,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":null,"% Linea gratis":null},{"Mes":"202505","ID PDV":"55632","Fibras brutas":0,"Mov activos":"0","Fibra activa":0,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":null,"% Linea gratis":null},{"Mes":"202508","ID PDV":"55632","Fibras brutas":0,"Mov activos":"0","Fibra activa":0,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":null,"% Linea gratis":null},{"Mes":"202404","ID PDV":"55632","Fibras brutas":1,"Mov activos":null,"Fibra activa":null,"Mov en vuelo":0,"Prepago activa":null,"Días instalación":"40.00","% Linea gratis":null},{"Mes":"202407","ID PDV":"57317","Fibras brutas":3,"Mov activos":"5","Fibra activa":3,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":"7.00","% Linea gratis":0.2},{"Mes":"202509","ID PDV":"57317","Fibras brutas":1,"Mov activos":"2","Fibra activa":0,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":null,"% Linea gratis":0},{"Mes":"202509","ID PDV":"55632","Fibras brutas":0,"Mov activos":"0","Fibra activa":0,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":null,"% Linea gratis":null},{"Mes":"202412","ID PDV":"57317","Fibras brutas":3,"Mov activos":"16","Fibra activa":4,"Mov en vuelo":0,"Prepago activa":0,"Días instalación":"14.00","% Linea gratis":0.23}];
        
        document.addEventListener('DOMContentLoaded', () => {

            // --- LÓGICA PRINCIPAL ---
            const kpiFunction = (data, month) => { /* ... sin cambios ... */ };
            const chartFunction = () => { /* ... sin cambios ... */ };
            
            // 6. NUEVO: Lógica completa para la nueva tabla dinámica
            const tableContainer = document.querySelector('#dataTable');
            const tableHead = tableContainer.querySelector('thead');
            const tableBody = tableContainer.querySelector('tbody');
            const monthFilter = document.getElementById('monthFilter');
            const pdvFilter = document.getElementById('pdvFilter');
            let currentSortColumn = 'Mes';
            let isSortAscending = false;

            function populateFilters() {
                const uniqueMonths = [...new Set(salesData.map(item => item.Mes))].sort().reverse();
                const uniquePdvs = [...new Set(salesData.map(item => item["ID PDV"]))].sort();

                monthFilter.innerHTML = '<option value="all">Todos los Meses</option>';
                uniqueMonths.forEach(month => {
                    monthFilter.innerHTML += `<option value="${month}">${month}</option>`;
                });

                pdvFilter.innerHTML = '<option value="all">Todos los PDV</option>';
                uniquePdvs.forEach(pdv => {
                    pdvFilter.innerHTML += `<option value="${pdv}">${pdv}</option>`;
                });
                
                monthFilter.addEventListener('change', renderTable);
                pdvFilter.addEventListener('change', renderTable);
            }

            function renderTable() {
                // Filtrar datos
                const selectedMonth = monthFilter.value;
                const selectedPdv = pdvFilter.value;

                let filteredData = salesData.filter(item => {
                    const monthMatch = (selectedMonth === 'all' || item.Mes === selectedMonth);
                    const pdvMatch = (selectedPdv === 'all' || item["ID PDV"] === selectedPdv);
                    return monthMatch && pdvMatch;
                });
                
                // Limpiar tabla
                tableHead.innerHTML = '';
                tableBody.innerHTML = '';
                
                if (filteredData.length === 0) return;

                // Crear cabeceras dinámicamente
                const headers = Object.keys(filteredData[0]);
                const headerRow = document.createElement('tr');
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    th.dataset.column = header;
                    headerRow.appendChild(th);
                });
                tableHead.appendChild(headerRow);
                
                // Crear filas
                filteredData.forEach(item => {
                    const row = document.createElement('tr');
                    headers.forEach(header => {
                        const cell = document.createElement('td');
                        cell.textContent = item[header] === null ? '-' : item[header];
                        row.appendChild(cell);
                    });
                    tableBody.appendChild(row);
                });
                
                // Ajustar columnas fijas
                adjustStickyColumns();
            }

            // 7. NUEVO: Función para ajustar el 'left' de la segunda columna fija
            function adjustStickyColumns() {
                const firstColumn = document.querySelector('#dataTable th:nth-child(1)');
                if (firstColumn) {
                    const firstColumnWidth = firstColumn.offsetWidth;
                    document.querySelectorAll('#dataTable th:nth-child(2), #dataTable td:nth-child(2)').forEach(el => {
                        el.style.left = `${firstColumnWidth}px`;
                    });
                }
            }
            
            // Lógica de KPIs (sin cambios)
            const allMonths = salesData.map(item => item.Mes);
            const mostRecentMonth = Math.max(...allMonths.map(Number)).toString();
            const recentMonthData = salesData.filter(item => item.Mes === mostRecentMonth);
            //calculateAndDisplayKPIs(recentMonthData, mostRecentMonth);
            
            // Gráfico (sin cambios)
            const labels = [...new Set(salesData.map(item => item.Mes))].sort().reverse();
            // ... (resto de la lógica del gráfico)
            
            // Carga inicial
            populateFilters();
            renderTable();
            window.addEventListener('resize', adjustStickyColumns); // Reajustar al cambiar tamaño de ventana
        });
    </script>
</body>
</html>
