<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard PDV v2.8</title>
  <!-- Librería para Gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>

  <style>
    /* Estilos Generales */
    :root {
      --primary-color: #007bff;
      --secondary-color: #6c757d;
      --background-color: #f8f9fa;
      --card-bg-color: #ffffff;
      --text-color: #333;
      --rappel-plata: rgba(40, 167, 69, 0.5);
      --rappel-oro: rgba(23, 162, 184, 0.5);
      --rappel-platino: rgba(255, 193, 7, 0.5);
      --rappel-diamante: rgba(220, 53, 69, 0.5);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      margin: 0;
      padding: 15px;
      font-size: 14px;
      position: relative;
    }
    .version-tag {
        position: absolute;
        top: 8px;
        left: 8px;
        font-size: 10px;
        color: #aaa;
        background-color: rgba(0,0,0,0.05);
        padding: 2px 5px;
        border-radius: 4px;
    }
    .dashboard-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    /* Sección de Datos del Contacto */
    .contact-info {
      display: grid;
      /* Ajustado para 5 columnas, forzando una sola fila */
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      background-color: var(--card-bg-color);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    .info-item { text-align: left; }
    .info-item-label {
      font-weight: 600;
      color: var(--secondary-color);
      font-size: 11px;
      margin-bottom: 2px;
    }
    .info-item-value {
      font-weight: 500;
      padding: 4px 8px;
      border-radius: 6px;
      background-color: #e9ecef;
      font-size: 13px;
    }

    /* Sección de Tarjetas KPI */
    .kpi-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }
    .card {
      background-color: var(--card-bg-color);
      padding: 10px; /* Padding reducido */
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    .card-title {
      font-size: 12px; /* Ligeramente reducido */
      font-weight: 600;
      color: var(--secondary-color);
      margin-bottom: 5px;
    }
    .card-value {
      font-size: 24px; /* Tamaño de números reducido */
      font-weight: 700;
      color: var(--primary-color);
    }

    /* Contenedor de Gráfico y Leyenda Rappel */
     .chart-section-container {
        display: flex;
        flex-direction: row;
        gap: 15px;
        align-items: stretch;
    }
    .chart-container {
        flex-grow: 1;
        background-color: var(--card-bg-color);
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        height: 300px; /* Altura de gráfico aumentada */
    }
    .rappel-legend-container {
        flex-shrink: 0;
        width: 130px;
        background-color: var(--card-bg-color);
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 12px;
    }
    .rappel-legend-container h6 {
        margin: 0 0 5px 0;
        text-align: center;
        color: var(--secondary-color);
        font-weight: 600;
        font-size: 14px;
    }
    .rappel-item {
        display: flex;
        align-items: center;
        font-size: 12px;
    }
    .rappel-color-box {
        width: 12px;
        height: 12px;
        margin-right: 8px;
        border-radius: 3px;
        flex-shrink: 0;
    }

    /* Tabla Interactiva */
    .table-container {
      background-color: var(--card-bg-color);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    .table-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    .table-controls input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    #interactive-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    #interactive-table th, #interactive-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
    }
    #interactive-table th {
      cursor: pointer;
      user-select: none;
    }
    #interactive-table th:hover { background-color: #f1f1f1; }
    /* Estilo para filas intercaladas */
    #interactive-table tbody tr:nth-child(even) { background-color: #f8f9fa; }
    #interactive-table tbody tr:hover { background-color: #e9ecef; }

  </style>
</head>
<body>
  <div class="version-tag">v2.8</div>
  <div class="dashboard-container">
    <!-- Sección de Info de Contacto -->
    <div class="contact-info" id="contact-info-container">
      <!-- Los datos se inyectarán aquí desde JS -->
    </div>
    
    <!-- Sección de KPIs -->
    <div class="kpi-cards">
      <div class="card"><div class="card-title">Fibras Brutas</div><div id="fibra" class="card-value">-</div></div>
      <div class="card"><div class="card-title">Proyección Fibra</div><div id="proyeccion" class="card-value">-</div></div>
      <div class="card"><div class="card-title">Mov Activos</div><div id="movact" class="card-value">-</div></div>
      <div class="card"><div class="card-title">Mov en Vuelo</div><div id="movvuelo" class="card-value">-</div></div>
      <div class="card"><div class="card-title">% Línea Gratis</div><div id="gratis" class="card-value">-</div></div>
      <div class="card"><div class="card-title">Días Instalación</div><div id="dias" class="card-value">-</div></div>
    </div>

    <!-- Sección de Gráfico y Leyenda -->
    <div class="chart-section-container">
      <div class="chart-container">
        <canvas id="historical-chart"></canvas>
      </div>
      <div class="rappel-legend-container" id="rappel-legend">
        <!-- Leyenda de Rappel se inyectará aquí -->
      </div>
    </div>


    <!-- Sección de Tabla -->
    <div class="table-container">
      <div class="table-controls">
        <input type="text" id="filter-mes" placeholder="Filtrar por Mes (ej: 202509)">
        <input type="text" id="filter-pdv" placeholder="Filtrar por ID PDV">
      </div>
      <table id="interactive-table">
        <thead><tr id="table-header"></tr></thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
  </div>

<script>
window.addEventListener('load', () => {
    let hasProcessed = false;
    let n8nDataCache = [];
    let historicalChart = null;

    function handleWindowMessage(event) {
        if (event.source !== window.parent || hasProcessed) return;
        try {
            const parsedData = JSON.parse(event.data);
            const pdvId = parsedData?.data?.contact?.custom_attributes?.id_pdv;
            
            if (pdvId) {
                hasProcessed = true;
                updateContactInfo(parsedData.data.contact);
                fetchPdvData(pdvId);
            }
        } catch (error) { /* Ignorar mensajes no JSON */ }
    }
    window.addEventListener('message', handleWindowMessage);
    window.parent.postMessage('chatwoot-dashboard-app:loaded', '*');
    
    function updateContactInfo(contact) {
        const container = document.getElementById('contact-info-container');
        const customAttrs = contact.custom_attributes;
        const additionalAttrs = contact.additional_attributes;

        const info = {
            'Empresa': additionalAttrs.company_name || '-',
            'Estado PDV': customAttrs.statuspdv || '-',
            'Documentación': customAttrs.documentacion || '-',
            'Permisos': customAttrs.permisos || '-',
            'WhatsApp': customAttrs.whatsapp || '-'
        };

        container.innerHTML = Object.entries(info).map(([label, value]) => `
            <div class="info-item">
                <div class="info-item-label">${label}</div>
                <div class="info-item-value">${value}</div>
            </div>
        `).join('');
    }

    async function fetchPdvData(pdvId) {
        try {
            const url = `https://n8n.vozipyme.es/webhook/dashboard_chatwoot_pdv?pdv_id=${pdvId}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
            const data = await response.json();
            n8nDataCache = data;
            
            updateKpis(data);
            renderChart(data);
            // Ordenación inicial de la tabla
            renderTable(data, 'Mes', 'desc'); 
        } catch (error) {
            console.error("Error al cargar datos de n8n:", error);
        }
    }
    
    function updateKpis(data) {
        const currentMonthId = new Date().toISOString().slice(0, 7).replace('-', '');
        const record = data.find(row => row.Mes === currentMonthId);
        if (!record) return;

        const fibraBruta = parseFloat(record["Fibras brutas"]) || 0;
        const today = new Date();
        const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
        const dayOfMonth = today.getDate();
        const proyeccion = (fibraBruta / dayOfMonth) * daysInMonth;

        document.getElementById('fibra').textContent = record["Fibras brutas"] ?? '-';
        document.getElementById('proyeccion').textContent = proyeccion.toFixed(2);
        document.getElementById('movact').textContent = record["Mov activos"] ?? '-';
        document.getElementById('movvuelo').textContent = record["Mov en vuelo"] ?? '-';
        document.getElementById('gratis').textContent = record["% Linea gratis"] ?? '-';
        document.getElementById('dias').textContent = record["Días instalación"] ?? '-';
    }

    function renderRappelLegend(rappels) {
        const legendContainer = document.getElementById('rappel-legend');
        const colors = ['var(--rappel-plata)', 'var(--rappel-oro)', 'var(--rappel-platino)', 'var(--rappel-diamante)'];
        
        let legendHTML = '<h6>Objetivos Rappel</h6>';
        let index = 0;
        for (const label in rappels) {
            legendHTML += `
                <div class="rappel-item">
                    <div class="rappel-color-box" style="background-color: ${colors[index]};"></div>
                    <span>${label}</span>
                </div>`;
            index++;
        }
        legendContainer.innerHTML = legendHTML;
    }

    function renderChart(data) {
        const ctx = document.getElementById('historical-chart').getContext('2d');
        const labels = data.map(d => d.Mes); // No se invierte para que coincida con la tabla
        const fibraData = data.map(d => d["Fibras brutas"]);
        const movActivosData = data.map(d => d["Mov activos"]);
        
        const proyeccionData = data.map(d => {
            const fibraBruta = parseFloat(d["Fibras brutas"]) || 0;
            const year = parseInt(d.Mes.substring(0, 4));
            const month = parseInt(d.Mes.substring(4, 6));
            const daysInMonth = new Date(year, month, 0).getDate();
            if (`${year}${String(month).padStart(2, '0')}` === new Date().toISOString().slice(0,7).replace('-','')) {
                 const dayOfMonth = new Date().getDate();
                 return (fibraBruta / dayOfMonth) * daysInMonth;
            }
            return fibraBruta;
        });
        
        const rappels = {
            'Plata (3)': 3,
            'Oro (9)': 9,
            'Platino (20)': 20,
            'Diamante (36)': 36
        };
        
        renderRappelLegend(rappels);

        if (historicalChart) {
            historicalChart.destroy();
        }

        historicalChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Fibra Bruta', data: fibraData, borderColor: 'var(--primary-color)', tension: 0.1, fill: false },
                    { label: 'Proyección Fibra', data: proyeccionData, borderColor: 'var(--rappel-oro)', tension: 0.1, borderDash: [5, 5], fill: false },
                    { label: 'Mov Activos', data: movActivosData, borderColor: 'var(--rappel-plata)', tension: 0.1, fill: false }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }, // Leyenda de líneas quitada
                    title: { display: false }, // Título de gráfico quitado
                    annotation: {
                        annotations: Object.entries(rappels).map(([label, value], index) => ({
                            type: 'line',
                            yMin: value,
                            yMax: value,
                            borderColor: ['var(--rappel-plata)', 'var(--rappel-oro)', 'var(--rappel-platino)', 'var(--rappel-diamante)'][index],
                            borderWidth: 1, // Linea más fina
                            borderDash: [10, 5]
                        }))
                    }
                },
                scales: { 
                    x: { ticks: { font: { size: 10 } } }, // Tamaño de meses reducido
                    y: { beginAtZero: true } 
                }
            }
        });
    }

    function renderTable(data, sortKey = null, sortOrder = 'asc') {
        const tableBody = document.getElementById('table-body');
        const tableHeader = document.getElementById('table-header');
        
        if (!data || data.length === 0) {
            tableHeader.innerHTML = '';
            tableBody.innerHTML = `<tr><td colspan="100%" style="text-align: center;">No hay datos históricos disponibles.</td></tr>`;
            return;
        }

        let sortedData = [...data];

        if (sortKey) {
            sortedData.sort((a, b) => {
                const valA = a[sortKey];
                const valB = b[sortKey];
                if (typeof valA === 'string' && typeof valB === 'string') {
                    // Ordenación descendente correcta para texto
                    return sortOrder === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                }
                return sortOrder === 'asc' ? valA - valB : valB - valA;
            });
        }
        
        if (tableHeader.innerHTML === '' || tableHeader.dataset.rendered !== 'true') {
            tableHeader.dataset.rendered = 'true';
            const headers = Object.keys(data[0]);
            tableHeader.innerHTML = headers.map(key => `<th data-key="${key}">${key} <span></span></th>`).join('');
            document.querySelectorAll('#table-header th').forEach(th => {
                th.addEventListener('click', () => {
                    const key = th.dataset.key;
                    const currentOrder = th.dataset.order || 'asc';
                    const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
                    document.querySelectorAll('#table-header th').forEach(innerTh => {
                        innerTh.dataset.order = '';
                        innerTh.querySelector('span').textContent = '';
                    });
                    th.querySelector('span').textContent = newOrder === 'asc' ? '▲' : '▼';
                    th.dataset.order = newOrder;
                    // Al hacer clic, se re-renderiza con el filtro actual
                    applyFilters(key, newOrder);
                });
            });
        }

        tableBody.innerHTML = sortedData.map(row => `
            <tr>${Object.values(row).map(cell => `<td>${cell}</td>`).join('')}</tr>
        `).join('');
    }

    function applyFilters(sortKey = 'Mes', sortOrder = 'desc') {
        const mesFilter = document.getElementById('filter-mes').value.toLowerCase();
        const pdvFilter = document.getElementById('filter-pdv').value.toLowerCase();

        const filteredData = n8nDataCache.filter(row => {
            const mesMatch = row.Mes.toLowerCase().includes(mesFilter);
            const pdvMatch = row['ID PDV'].toLowerCase().includes(pdvFilter);
            return mesMatch && pdvMatch;
        });
        renderTable(filteredData, sortKey, sortOrder);
    }
    document.getElementById('filter-mes').addEventListener('input', applyFilters);
    document.getElementById('filter-pdv').addEventListener('input', applyFilters);

});
</script>

</body>
</html>
