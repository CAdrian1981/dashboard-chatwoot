<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Ventas PDV</title>
    




<script>
  let salesChart = null;
  let originalSalesData = [];

  function calculateAndDisplayKPIs(data, month) {
    const safeNum = (val) => { const num = parseFloat(String(val).replace(',', '.')); return isFinite(num) ? num : 0; };
    const year = month.substring(0, 4);
    const monthIndex = parseInt(month.substring(4, 6), 10) - 1;
    const date = new Date(year, monthIndex);
    const monthName = date.toLocaleString('es-ES', { month: 'long', year: 'numeric' });
    document.getElementById('kpi-month-title').textContent = `Totales para ${monthName.charAt(0).toUpperCase() + monthName.slice(1)}`;
    const totalFibraBruta = data.reduce((sum, item) => sum + safeNum(item["Fibras brutas"]), 0);
    document.getElementById('total-fibra-bruta').textContent = totalFibraBruta;
    const totalMovActivo = data.reduce((sum, item) => sum + safeNum(item["Mov activos"]), 0);
    document.getElementById('total-mov-activo').textContent = totalMovActivo;
    const totalMovVuelo = data.reduce((sum, item) => sum + safeNum(item["Mov en vuelo"]), 0);
    document.getElementById('total-mov-vuelo').textContent = totalMovVuelo;
    const avgLineaGratis = (data.reduce((sum, item) => sum + safeNum(item["% Linea gratis"]), 0) / data.length).toFixed(2);
    document.getElementById('avg-linea-gratis').textContent = avgLineaGratis;
    const avgDiasInstal = (data.reduce((sum, item) => sum + safeNum(item["Días instalación"]), 0) / data.length).toFixed(2);
    document.getElementById('avg-dias-instal').textContent = avgDiasInstal;
  }

  function renderChart(salesData) {}
  function setupTable(salesData) {}

  async function initializeDashboard(pdvId) {
    if (!pdvId) {
      document.getElementById('kpi-month-title').textContent = "ID PDV no disponible.";
      return;
    }

    try {
      document.getElementById('kpi-month-title').textContent = `Cargando datos para PDV: ${pdvId}...`;
      const response = await fetch(`https://n8n.vozipyme.es/webhook/dashboard_chatwoot_pdv?pdv_id=${pdvId}`);
      const data = await response.json();
      if (!data || data.length === 0) {
        document.getElementById('kpi-month-title').textContent = "No hay datos para este PDV.";
        return;
      }
      const mes = data[0]?.Mes || "";
      calculateAndDisplayKPIs(data, mes);
      renderChart(data);
      setupTable(data);
    } catch (error) {
      console.error("Error cargando datos:", error);
      document.getElementById('kpi-month-title').textContent = "Error al cargar datos.";
    }
  }

  function handleAppContext(event) {
    if (!event?.data || typeof event.data !== 'string') return;
    let payload;
    try {
      payload = JSON.parse(event.data);
    } catch (e) {
      return;
    }
    if (payload.event !== "appContext") return;

    const pdvId = payload?.data?.contact?.custom_attributes?.id_pdv;
    initializeDashboard(pdvId);
  }

  window.addEventListener("message", handleAppContext);
  window.parent.postMessage("chatwoot-dashboard-app:fetch-info", "*");
</script>

</body>
</html>
