<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visor de Ventas v2.0</title>
  <style>
    :root {
      --primary-color: #007bff;
      --background-color: #f8f9fa;
      --card-bg-color: #ffffff;
      --text-color: #333;
      --border-color: #dee2e6;
      --hover-color: #e9ecef;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      margin: 0;
      padding: 20px;
      font-size: 14px;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .card {
      background-color: var(--card-bg-color);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    .header h1 {
      margin: 0 0 20px 0;
      font-size: 20px;
    }
    
    /* Vista de Detalles */
    #details-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      padding: 15px;
      border: 1px dashed var(--border-color);
      border-radius: 8px;
      min-height: 50px;
      align-content: flex-start;
    }
    .details-placeholder {
        color: #6c757d;
        align-self: center;
        justify-self: center;
        grid-column: 1 / -1;
    }
    .detail-item {
      font-size: 13px;
    }
    .detail-item-label {
      font-weight: 600;
      color: #6c757d;
      font-size: 11px;
      margin-bottom: 4px;
      text-transform: uppercase;
    }

    /* Tabla y Filtros */
    .table-wrapper {
      overflow-x: auto;
    }
    #sales-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    #sales-table th, #sales-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
      white-space: nowrap;
    }
    #sales-table thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    #sales-table .header-row th {
      background-color: #f8f9fa;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
    }
    #sales-table .filter-row th {
      background-color: #f8f9fa;
      padding: 8px;
    }
    .filter-row select, .filter-row input {
      width: 100%;
      padding: 6px;
      font-size: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #sales-table tbody tr {
      cursor: pointer;
    }
    #sales-table tbody tr:hover, #sales-table tbody tr.selected {
      background-color: var(--hover-color);
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="card">
        <div class="header">
            <h1 id="main-title">Detalles de la Venta</h1>
        </div>
        <div id="details-container">
            <p class="details-placeholder">Selecciona una venta de la tabla para ver sus detalles</p>
        </div>
    </div>
    <div class="card">
      <div class="table-wrapper">
        <table id="sales-table">
          <thead>
            <tr class="header-row" id="table-header"></tr>
            <tr class="filter-row" id="filter-row"></tr>
          </thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
window.addEventListener('load', () => {
    let hasProcessed = false;
    let salesDataCache = [];
    let activeFilters = {};

    function handleWindowMessage(event) {
        if (event.source !== window.parent || hasProcessed) return;
        try {
            const parsedData = JSON.parse(event.data);
            const pdvId = parsedData?.data?.contact?.custom_attributes?.id_pdv;
            
            if (pdvId) {
                hasProcessed = true;
                fetchVentasData(pdvId);
            }
        } catch (error) {}
    }
    window.addEventListener('message', handleWindowMessage);
    window.parent.postMessage('chatwoot-dashboard-app:loaded', '*');

    async function fetchVentasData(pdvId) {
        try {
            const url = `https://n8n.vozipyme.es/webhook/4abcfbd2-ec57-471b-b580-927938988ee9?id_pdv=${pdvId}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
            const data = await response.json();
            salesDataCache = data;
            
            initializeTable(data);
        } catch (error) {
            document.getElementById('table-body').innerHTML = `<tr><td colspan="100%" style="text-align: center; color: red;">Error al cargar datos.</td></tr>`;
        }
    }

    function initializeTable(data) {
        if (!data || data.length === 0) {
            document.getElementById('table-body').innerHTML = `<tr><td colspan="100%" style="text-align: center;">No se encontraron ventas.</td></tr>`;
            return;
        }
        
        const headers = Object.keys(data[0]);
        renderTableHeaders(headers);
        renderFilterRow(headers, data);
        renderTableBody(data);
    }

    function renderTableHeaders(headers) {
        const headerRow = document.getElementById('table-header');
        headerRow.innerHTML = headers.map(key => `<th data-key="${key}">${key.replace(/_/g, ' ')} <span></span></th>`).join('');
        
        headerRow.querySelectorAll('th').forEach(th => {
            th.addEventListener('click', () => {
                const key = th.dataset.key;
                const currentOrder = th.dataset.order || 'desc';
                const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
                
                headerRow.querySelectorAll('th').forEach(innerTh => {
                    innerTh.dataset.order = '';
                    innerTh.querySelector('span').textContent = '';
                });

                th.querySelector('span').textContent = newOrder === 'asc' ? '▲' : '▼';
                th.dataset.order = newOrder;
                applyFiltersAndSort(key, newOrder);
            });
        });
    }

    function renderFilterRow(headers, data) {
        const filterRow = document.getElementById('filter-row');
        filterRow.innerHTML = headers.map(key => {
            if (key.toLowerCase().includes('fecha')) {
                return `<th>
                    <input type="date" class="filter-input" data-key="${key}" data-type="date-from" placeholder="Desde">
                    <input type="date" class="filter-input" data-key="${key}" data-type="date-to" placeholder="Hasta">
                </th>`;
            } else {
                 return `<th><select class="filter-input" data-key="${key}"><option value="">Todo</option></select></th>`;
            }
        }).join('');
        
        updateFilterOptions(data);

        document.querySelectorAll('.filter-input').forEach(input => {
            input.addEventListener('change', () => applyFiltersAndSort());
        });
    }
    
    function updateFilterOptions(data) {
        const headers = Object.keys(salesDataCache[0] || {});
        headers.forEach(key => {
            if (!key.toLowerCase().includes('fecha')) {
                const select = document.querySelector(`.filter-input[data-key="${key}"]`);
                const selectedValue = select.value;
                const options = [...new Set(data.map(item => item[key]))].sort();
                
                select.innerHTML = '<option value="">Todo</option>';
                options.forEach(option => {
                    if(option) {
                        const isSelected = option === selectedValue ? 'selected' : '';
                        select.innerHTML += `<option value="${option}" ${isSelected}>${option}</option>`;
                    }
                });
            }
        });
    }
    
    function applyFiltersAndSort(sortKey = null, sortOrder = 'desc') {
        // 1. Recoger filtros activos
        activeFilters = {};
        document.querySelectorAll('.filter-input').forEach(input => {
            const key = input.dataset.key;
            if (input.type.startsWith('date')) {
                if (!activeFilters[key]) activeFilters[key] = {};
                activeFilters[key][input.dataset.type] = input.value;
            } else {
                if (input.value) activeFilters[key] = input.value;
            }
        });

        // 2. Filtrar datos
        let filteredData = salesDataCache.filter(row => {
            return Object.entries(activeFilters).every(([key, value]) => {
                if (typeof value === 'object') { // Rango de fechas
                    const rowDate = new Date(String(row[key]).replace(/\"/g, ''));
                    if (isNaN(rowDate)) return true;
                    const from = value['date-from'] ? new Date(value['date-from']) : null;
                    const to = value['date-to'] ? new Date(value['date-to']) : null;
                    if (from && rowDate < from) return false;
                    if (to && rowDate > to) return false;
                    return true;
                }
                return String(row[key]) === String(value); // Filtro de select
            });
        });

        // 3. Ordenar datos filtrados
        if (sortKey) {
            filteredData.sort((a, b) => {
                const valA = a[sortKey], valB = b[sortKey];
                if (String(valA) < String(valB)) return sortOrder === 'asc' ? -1 : 1;
                if (String(valA) > String(valB)) return sortOrder === 'asc' ? 1 : -1;
                return 0;
            });
        }
        
        // 4. Actualizar opciones de los otros filtros (cascada)
        updateFilterOptions(filteredData);
        // 5. Renderizar el cuerpo de la tabla
        renderTableBody(filteredData);
    }
    
    function renderTableBody(data) {
        const tableBody = document.getElementById('table-body');
        tableBody.innerHTML = data.map(row => {
            const cells = Object.values(row).map(cell => `<td>${String(cell || '-').replace(/\"/g, '')}</td>`).join('');
            const rowEl = document.createElement('tr');
            rowEl.innerHTML = cells;
            rowEl.addEventListener('click', () => {
                showDetails(row);
                document.querySelectorAll('#sales-table tbody tr').forEach(tr => tr.classList.remove('selected'));
                rowEl.classList.add('selected');
            });
            return rowEl.outerHTML;
        }).join('');
    }

    function showDetails(row) {
        const detailsContainer = document.getElementById('details-container');
        detailsContainer.innerHTML = Object.entries(row).map(([key, value]) => `
            <div class="detail-item">
                <div class="detail-item-label">${key.replace(/_/g, ' ')}</div>
                <div>${String(value || '-').replace(/\"/g, '')}</div>
            </div>
        `).join('');
    }
});
</script>

</body>
</html>

