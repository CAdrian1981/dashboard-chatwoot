<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visor de Ventas v3.4</title>
  <style>
    :root {
      --primary-color: #007bff;
      --secondary-color: #6c757d;
      --background-color: #f8f9fa;
      --card-bg-color: #ffffff;
      --text-color: #333;
      --border-color: #dee2e6;
      --hover-color: #e9ecef;
      --stripe-color: #f8f9fa;
      --success-color: #28a745;
      --error-color: #dc3545;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      margin: 0;
      padding: 20px;
      font-size: 14px;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .card {
      background-color: var(--card-bg-color);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    .header {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 10px; /* Espacio entre botones */
        margin-bottom: 20px;
    }
    .btn {
        padding: 8px 12px;
        font-size: 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid var(--primary-color);
        background-color: transparent;
        color: var(--primary-color);
    }
    .btn:hover {
        background-color: var(--primary-color);
        color: white;
    }
    #export-btn {
        background-color: var(--primary-color);
        color: white;
    }
    #export-btn:hover {
        background-color: #0056b3;
        border-color: #0056b3;
    }
    
    /* Vista de Detalles */
    #details-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      padding: 15px;
      border: 1px dashed var(--border-color);
      border-radius: 8px;
      min-height: 50px;
      align-content: flex-start;
    }
    .details-placeholder {
        color: #6c757d;
        align-self: center;
        justify-self: center;
        grid-column: 1 / -1;
    }
    .detail-item { font-size: 13px; }
    .detail-item-label {
      font-weight: 600;
      color: #6c757d;
      font-size: 11px;
      margin-bottom: 4px;
      text-transform: uppercase;
    }

    /* Tabla y Filtros */
    .table-wrapper { overflow-x: auto; }
    #sales-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    #sales-table th, #sales-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
      white-space: nowrap;
    }
    #sales-table thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    #sales-table .header-row th {
      background-color: #f8f9fa;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
    }
    #sales-table .filter-row th {
      background-color: #f8f9fa;
      padding: 8px;
    }
    .filter-row select, .filter-row input {
      width: 100%;
      box-sizing: border-box;
      padding: 6px;
      font-size: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .filter-row select[multiple] {
        height: 80px;
        padding: 0;
    }
    .filter-row select[multiple] option {
        padding: 5px;
    }
    .date-filter-container {
        display: flex;
        gap: 5px;
    }
    #sales-table tbody tr { cursor: pointer; }
    #sales-table tbody tr:nth-child(even) {
        background-color: var(--stripe-color);
    }
    #sales-table tbody tr:hover, #sales-table tbody tr.selected {
      background-color: var(--hover-color);
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="card">
        <div class="header">
            <button id="clear-filters-btn" class="btn">Limpiar Filtros</button>
            <button id="export-btn" class="btn">Crear Hoja de Cálculo</button>
        </div>
        <div id="details-container">
            <p class="details-placeholder">Selecciona una venta de la tabla para ver sus detalles</p>
        </div>
    </div>
    <div class="card">
      <div class="table-wrapper">
        <table id="sales-table">
          <thead>
            <tr class="header-row" id="table-header"></tr>
            <tr class="filter-row" id="filter-row"></tr>
          </thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
window.addEventListener('load', () => {
    let hasProcessed = false;
    let salesDataCache = [];
    let activeFilters = {};
    let currentFilteredData = [];

    // --- (Funciones de inicialización y filtros sin cambios) ---
    function handleWindowMessage(event) { if (event.source !== window.parent || hasProcessed) return; try { const parsedData = JSON.parse(event.data); const pdvId = parsedData?.data?.contact?.custom_attributes?.id_pdv; if (pdvId) { hasProcessed = true; fetchVentasData(pdvId); } } catch (error) {} }
    async function fetchVentasData(pdvId) { try { const url = `https://n8n.vozipyme.es/webhook/4abcfbd2-ec57-471b-b580-927938988ee9?id_pdv=${pdvId}`; const response = await fetch(url); if (!response.ok) throw new Error(`HTTP Error: ${response.status}`); const data = await response.json(); salesDataCache = data; initializeTable(data); } catch (error) { document.getElementById('table-body').innerHTML = `<tr><td colspan="100%" style="text-align: center; color: red;">Error al cargar datos.</td></tr>`; } }
    
    function initializeTable(data) {
        if (!data || data.length === 0) {
            document.getElementById('table-body').innerHTML = `<tr><td colspan="100%" style="text-align: center;">No se encontraron ventas.</td></tr>`;
            return;
        }
        const headers = Object.keys(data[0]);
        renderTableHeaders(headers);
        renderFilterRow(headers);
        currentFilteredData = data;
        renderTableBody(data);

        document.getElementById('clear-filters-btn').addEventListener('click', () => {
             document.querySelectorAll('.filter-input').forEach(input => {
                if(input.type === 'date') input.value = '';
                else Array.from(input.options).forEach(opt => opt.selected = false);
             });
             applyFiltersAndSort();
        });

        // Evento para el botón de exportación actualizado
        document.getElementById('export-btn').addEventListener('click', async () => {
            await sendDataToN8n(currentFilteredData);
        });
    }

    // --- (Funciones de renderizado y filtros sin cambios) ---
    function renderTableHeaders(headers) { const headerRow = document.getElementById('table-header'); headerRow.innerHTML = headers.map(key => `<th data-key="${key}">${key.replace(/_/g, ' ')} <span></span></th>`).join(''); headerRow.querySelectorAll('th').forEach(th => { th.addEventListener('click', () => { const key = th.dataset.key; const currentOrder = th.dataset.order || 'desc'; const newOrder = currentOrder === 'asc' ? 'desc' : 'asc'; headerRow.querySelectorAll('th').forEach(innerTh => { innerTh.dataset.order = ''; innerTh.querySelector('span').textContent = ''; }); th.querySelector('span').textContent = newOrder === 'asc' ? '▲' : '▼'; th.dataset.order = newOrder; applyFiltersAndSort(key, newOrder); }); }); }
    function renderFilterRow(headers) { const filterRow = document.getElementById('filter-row'); filterRow.innerHTML = headers.map(key => { if (key.toLowerCase().includes('fecha')) { return `<th><div class="date-filter-container"><input type="date" class="filter-input" data-key="${key}" data-type="date-from" title="Fecha desde"><input type="date" class="filter-input" data-key="${key}" data-type="date-to" title="Fecha hasta"></div></th>`; } else { return `<th><select class="filter-input" data-key="${key}" multiple></select></th>`; } }).join(''); updateFilterOptions(); document.querySelectorAll('.filter-input').forEach(input => { input.addEventListener('change', () => applyFiltersAndSort()); }); }
    function updateFilterOptions() { const headers = Object.keys(salesDataCache[0] || {}); headers.forEach(key => { if (key.toLowerCase().includes('fecha')) return; const otherFilters = { ...activeFilters }; delete otherFilters[key]; const relevantData = salesDataCache.filter(row => { return Object.entries(otherFilters).every(([filterKey, value]) => { if (Array.isArray(value) && value.length > 0) { return value.includes(String(row[filterKey])); } if (typeof value === 'object' && value !== null && !Array.isArray(value)) { const rowDate = new Date(String(row[filterKey]).replace(/\"/g, '')); if (isNaN(rowDate)) return true; const from = value['date-from'] ? new Date(value['date-from']) : null; const toRaw = value['date-to'] ? new Date(value['date-to']) : null; let to = toRaw ? new Date(new Date(toRaw).setHours(23, 59, 59, 999)) : null; if (from && rowDate < from) return false; if (to && rowDate > to) return false; return true; } return true; }); }); const select = document.querySelector(`.filter-input[data-key="${key}"]`); const currentSelections = activeFilters[key] || []; const options = [...new Set(relevantData.map(item => item[key]))].sort(); select.innerHTML = ''; options.forEach(option => { if (option) { const optionEl = document.createElement('option'); optionEl.value = option; optionEl.textContent = option; if (currentSelections.includes(option)) { optionEl.selected = true; } select.appendChild(optionEl); } }); }); }
    function applyFiltersAndSort(sortKey = null, sortOrder = 'desc') { activeFilters = {}; document.querySelectorAll('.filter-input').forEach(input => { const key = input.dataset.key; if (input.type.startsWith('date')) { if (!activeFilters[key]) activeFilters[key] = {}; activeFilters[key][input.dataset.type] = input.value; } else { const selectedValues = Array.from(input.selectedOptions).map(opt => opt.value); if (selectedValues.length > 0) activeFilters[key] = selectedValues; } }); let filteredData = salesDataCache.filter(row => { return Object.entries(activeFilters).every(([key, value]) => { if (Array.isArray(value)) { return value.includes(String(row[key])); } if (typeof value === 'object'  && value !== null && !Array.isArray(value)) { const rowDate = new Date(String(row[key]).replace(/\"/g, '')); if (isNaN(rowDate)) return true; const from = value['date-from'] ? new Date(value['date-from']) : null; const toRaw = value['date-to'] ? new Date(value['date-to']) : null; let to = toRaw ? new Date(new Date(toRaw).setHours(23, 59, 59, 999)) : null; if (from && rowDate < from) return false; if (to && rowDate > to) return false; return true; } return true; }); }); if (sortKey) { filteredData.sort((a, b) => { const valA = a[sortKey], valB = b[sortKey]; if (String(valA) < String(valB)) return sortOrder === 'asc' ? -1 : 1; if (String(valA) > String(valB)) return sortOrder === 'asc' ? 1 : -1; return 0; }); } currentFilteredData = filteredData; updateFilterOptions(); renderTableBody(filteredData); }
    function formatDate(dateString) { if (!dateString) return '-'; const cleanString = String(dateString).replace(/\"/g, ''); const date = new Date(cleanString); if (isNaN(date.getTime())) return '-'; return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }); }
    function renderTableBody(data) { const tableBody = document.getElementById('table-body'); tableBody.innerHTML = ''; data.forEach(row => { const rowEl = document.createElement('tr'); const headers = Object.keys(salesDataCache[0] || {}); rowEl.innerHTML = headers.map(key => { const cellValue = row[key]; let cellContent = String(cellValue || '-').replace(/\"/g, ''); if (key.toLowerCase().includes('fecha')) { cellContent = formatDate(cellValue); } return `<td>${cellContent}</td>`; }).join(''); rowEl.addEventListener('click', () => { if (rowEl.classList.contains('selected')) { rowEl.classList.remove('selected'); clearDetails(); } else { document.querySelectorAll('#sales-table tbody tr').forEach(tr => tr.classList.remove('selected')); rowEl.classList.add('selected'); showDetails(row); } }); tableBody.appendChild(rowEl); }); }
    function showDetails(row) { const detailsContainer = document.getElementById('details-container'); detailsContainer.innerHTML = Object.entries(row).map(([key, value]) => { let displayValue = String(value || '-').replace(/\"/g, ''); if (key.toLowerCase().includes('fecha')) { displayValue = formatDate(value); } return `<div class="detail-item"><div class="detail-item-label">${key.replace(/_/g, ' ')}</div><div>${displayValue}</div></div>`; }).join(''); }
    function clearDetails() { const detailsContainer = document.getElementById('details-container'); detailsContainer.innerHTML = '<p class="details-placeholder">Selecciona una venta de la tabla para ver sus detalles</p>'; }
    
    // --- FUNCIÓN PARA ENVIAR DATOS A N8N ---
    async function sendDataToN8n(data) {
        // CORRECCIÓN: URL del webhook actualizada
        const n8nWebhookUrl = 'https://n8n.vozipyme.es/webhook/807a9c5a-fdd8-4455-a989-8487d42864b9';

        const exportBtn = document.getElementById('export-btn');
        const originalText = exportBtn.textContent;

        if (data.length === 0) {
            exportBtn.textContent = 'No hay datos';
            exportBtn.style.backgroundColor = 'var(--secondary-color)';
            setTimeout(() => {
                exportBtn.textContent = originalText;
                exportBtn.style.backgroundColor = 'var(--primary-color)';
            }, 2000);
            return;
        }

        exportBtn.textContent = 'Enviando...';
        exportBtn.disabled = true;

        try {
            const response = await fetch(n8nWebhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error(`Error en la respuesta de n8n: ${response.statusText}`);

            exportBtn.textContent = '¡Enviado!';
            exportBtn.style.backgroundColor = 'var(--success-color)';
        } catch (error) {
            console.error('Error al enviar datos a n8n:', error);
            exportBtn.textContent = 'Error';
            exportBtn.style.backgroundColor = 'var(--error-color)';
        } finally {
            setTimeout(() => {
                exportBtn.textContent = originalText;
                exportBtn.style.backgroundColor = 'var(--primary-color)';
                exportBtn.disabled = false;
            }, 3000);
        }
    }

    // Iniciar la comunicación con Chatwoot
    window.addEventListener('message', handleWindowMessage);
    window.parent.postMessage('chatwoot-dashboard-app:loaded', '*');
});
</script>

</body>
</html>

